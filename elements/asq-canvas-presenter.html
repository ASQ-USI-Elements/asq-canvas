<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../asq-base/asq-base.html">

<!--
`asq-canvas-presenter` provides the presenter view of `asq-canvas`.

Example:

    <asq-canvas-presenter for="leId">
    </asq-canvas-presenter>


@element asq-canvas-presenter
@demo demo/stats.html
@group ASQ Elements
@blurb Element provides a canvas for `asq-canvas` elements.
@homepage http://github.com/ASQ-USI-Elements/asq-canvas
-->
<dom-module id="asq-canvas-presenter">

  <template>

    <style>
      :host {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        --paper-swatch-picker-color-size: 10px;
      }

      #canvas{
        width: 100%;
        @apply(--layout-flex);
        cursor: crosshair;
      }

      #canvas:active {
        cursor: crosshair;
      }

      #drawingTools {
        position: absolute;
        left: 15px;
        bottom: 15px;
        pointer-events: auto;
      }

      #toggleDrawing {
        background-color: white;
        border-radius: 100px;
        transition: 1s;
        box-shadow: 0px 0px 1px;
      }

      #toggleDrawing:hover {
        cursor: pointer;
      }

      .drawingMenu {
        opacity: 0;
        height: 0;
        transition: 0.2s;
      }

      .activeMenu:hover {
        color: grey;
        transition: 0.2s;
      }

      #slideUtils {
        position: absolute;
        left: -1px;
        bottom: 20px;
        width: 40px;
        height: 0px;
        background-color: white;
        border: 1px solid #e2e2e2;
        border-radius: 4px;
        text-align: center;
        transition: 0.5s;
      }

      .activeSlideUtils {
        height: 145px !important;
        transition: 0.5s;
      }

      #impress .activeSlideUtils {
        height: 65px !important;
      }

      #impress #addSlide, #impress #removeSlide {
        display: none;
      }


      .activeMenu {
        opacity: 1;
        transition: 0.5s;
      }

      #penBtn {
        bottom: 47px;
      }

      #colorBtn {
        bottom: 47px;
        right: 7px;
        width: 40px;
        height: 40px;
      }

      #sizeBtn {
        right: 89px;
      }

      #eraseBtn {
        right: 89px;
        transform: rotate(-138deg);
      }

      #addSlideDialog {
        position: absolute;
        left: 29px;
        bottom: 80px;
        width: 180px;
        height: 100px;
        text-align: center;
      }

      #addSlideDialog .buttons {
        padding: 0;
        font-size: 12px;
        font-weight: bolder;
        line-height: 12px;
      }

      #addSlideDialog h2 {
        font-size: 21px;
        line-height: 20px;
        padding: 0 0 9px 0;
        margin-top: 20px;
      }

      #colorBtn::shadow paper-listbox {
        position: fixed;
        left: 68px;
        bottom: 103px;
        box-shadow: 0 16px 24px 2px rgba(0, 0, 0, 0.14), 0 6px 30px 5px rgba(0, 0, 0, 0.12), 0 8px 10px -5px rgba(0, 0, 0, 0.4);
      }

    </style>


  <canvas id="canvas" on-mousemove="_onMousemove" on-mousedown="_onMousedown" on-mouseup="_onMouseup" on-mousewheel="_onMousewheel"></canvas>

  <paper-dialog id="addSlideDialog">
    <h2>Add a new slide</h2>
    <div class="buttons">
      <paper-button on-click="_addSlideAfterCurrentSlide">after current slide</paper-button>
      <paper-button on-click="_addSlideAtEnd">at the end</paper-button>
    </div>
  </paper-dialog>

  <div id="drawingTools">
    <div id="slideUtils">
      <paper-icon-button id="addSlide" class="drawingMenu" title="add a new slide" icon="add" on-click="_openAddSlideDialog"></paper-icon-button>
      <paper-icon-button class="drawingMenu" title="remove a slide" icon="remove"></paper-icon-button>
      <paper-icon-button class="drawingMenu" title="download the current drawing" icon="file-download" on-click="_downloadCurrentCanvas"></paper-icon-button>
    </div>

    <paper-icon-button id="toggleDrawing" title="open drawing tools" icon="image:brush"></paper-icon-button>
    <paper-icon-button id="penBtn" class="drawingMenu" title="start drawing" icon="create"></paper-icon-button>
    <paper-swatch-picker id="colorBtn" class="drawingMenu" title="change color" color="{{selectedColor}}"></paper-swatch-picker>
    <paper-icon-button id="sizeBtn" class="drawingMenu" title="change pencil size" icon="image:lens"></paper-icon-button>
    <paper-icon-button id="eraseBtn" class="drawingMenu" title="use the eraser" icon="communication:no-sim"></paper-icon-button>
  </div>

  </template>
</dom-module>
<script>
  (function() {

    function rainbow(numOfSteps, step) {
        // This function generates vibrant, "evenly spaced" colours (i.e. no clustering). This is ideal for creating easily distinguishable vibrant markers in Google Maps and other apps.
        // Adam Cole, 2011-Sept-14
        // HSV to RBG adapted from: http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript
        var r, g, b;
        var h = step / numOfSteps;
        var i = ~~(h * 6);
        var f = h * 6 - i;
        var q = 1 - f;
        switch(i % 6){
            case 0: r = 1, g = f, b = 0; break;
            case 1: r = q, g = 1, b = 0; break;
            case 2: r = 0, g = 1, b = f; break;
            case 3: r = 0, g = q, b = 1; break;
            case 4: r = f, g = 0, b = 1; break;
            case 5: r = 1, g = 0, b = q; break;
        }
        var c = "#" + ("00" + (~ ~(r * 255)).toString(16)).slice(-2) + ("00" + (~ ~(g * 255)).toString(16)).slice(-2) + ("00" + (~ ~(b * 255)).toString(16)).slice(-2);
        return (c);
    }

    Polymer({

      is: 'asq-canvas-presenter',
      behaviors: [ASQ.asqElementBehavior],

      properties: {

        /**
         * Event bus to communicate with ASQ.
         */
        eventBus: {
          type: Object,
          notify: true
        },

        /**
         * whether the canvas will accept pointer events or not.
         */
        isInteractive: {
          type: Boolean,
          value: false,
          observer: "_isInteractiveChanged",
          notify: true
        },

        /**
         * Object that saves the drawing for its corresponding slide.
         */
        drawings: {
          type: Object,
          value: {},
        },

        /**
         * name of the last shown slide
         */
        lastStep: {
          type: String,
          value: "",
        }
      },


      attached: function(){
        this.ctx = this.$.canvas.getContext('2d');
        this.emptyCanvasData = this.$.canvas.toDataURL();
        this.lastX = 0;
        this.lastY = 0;
        this.color = 0;
        this.activeCanvas = false;
        this.keys = {
                      17: false, // control
                      68: false, // d
                      83: false, // s
                    };

        window.addEventListener('resize', this.resizeCanvas.bind(this), false);
        this.resizeCanvas();

        document.addEventListener("keydown", function(event) {
          switch (event.keyCode) {
            case 17:
              this.keys[17] = true;
              break;

            case 68:
              this.keys[68] = true;
              break;

            case 83:
              this.keys[83] = true;
              break;

            default:
              break;
          }

        }.bind(this));

        document.addEventListener("keyup", function(event) {
          let drawCommand, saveCommand; // control + d or s respectively

          switch (event.keyCode) {
            case 17:
              if (this.keys[68]) {
                drawCommand = true;
                this.keys[68] = false;
              }
              if (this.keys[83]) {
                saveCommand = true;
                this.keys[83] = false;
              }
              this.keys[17] = false;
              break;

            case 68:
              if (this.keys[17]) {
                drawCommand = true;
                this.keys[17] = false;
              }
              this.keys[68] = false;

            case 83:
              if (this.keys[17]) {
                saveCommand = true;
                this.keys[17] = false;
              }
              this.keys[83] = false;

            default:
              break;
          }

          if (drawCommand) {
            if (this.activeCanvas) {
              this.isInteractive = false;
              this.emitMakeNonInteractiveEvent();
              this.activeCanvas = !this.activeCanvas;
            } else {
              this.isInteractive = true;
              this.emitMakeInteractiveEvent();
              this.activeCanvas = !this.activeCanvas;
            }
          }

          if (saveCommand) {
            // download the canvas
            let link = document.createElement('a');
            Polymer.dom(this.root).appendChild(link);
            link.href = this.$.canvas.toDataURL();
            link.download = 'canvas';
            link.click();
            Polymer.dom(this.root).removeChild(link);
          }

        }.bind(this), false);

        // add the additional drawing slides if reveal is used
        if (document.querySelector('.reveal')) {
          this.emitGetSlidesEvent();
        }

      },

      resizeCanvas: function () {
        this.$.canvas.width = this.offsetWidth;
        this.$.canvas.height = this.offsetHeight;

        this.loadImage(this.lastStep);
        this.emitLoadImageEvent(this.drawings[this.lastStep]);
      },

      _isInteractiveChanged: function(newVal, oldVal){
        this.style.pointerEvents = newVal ? "auto" : "none";
      },

      // define a custom fillCircle method
      fillCircle : function(x1, y1, x2, y2, lineThickness) {
        //this.fillStyle = fillColor;

        var steep = (Math.abs(y2 - y1) > Math.abs(x2 - x1));
        if (steep) {
          var x = x1;
          x1 = y1;
          y1 = x;

          var y = y2;
          y2 = x2;
          x2 = y;
        }
        if (x1 > x2) {
          var x = x1;
          x1 = x2;
          x2 = x;

          var y = y1;
          y1 = y2;
          y2 = y;
        }

        var dx = x2 - x1, dy = Math.abs(y2 - y1), error = 0, de = dy / dx, yStep = -1, y = y1;

        if (y1 < y2) {
          yStep = 1;
        }

        for (var x = x1; x < x2; x++) {
          if (steep) {
            this.ctx.fillRect(y, x, lineThickness, lineThickness);
          } else {
            this.ctx.fillRect(x, y, lineThickness, lineThickness);
          }

          error += de;
          if (error >= 0.5) {
            y += yStep;
            error -= 1.0;
          }
        }
      },

      clearTo : function() {
        this.ctx.clearRect(0, 0, this.$.canvas.width, this.$.canvas.height);
      },

      loadImage: function(step) {
        let img = new Image();
        if (this.drawings[step]) {
          img.src = this.drawings[step];
          let context = this.ctx;
          img.addEventListener("load", function(evt) {
            setTimeout(function() {
              context.drawImage(img, 0, 0);
            }, 1000);
          });
        }
      },

      saveDrawingLocally: function() {
        this.drawings[this.lastStep] = this.$.canvas.toDataURL();
      },

      // bind mouse events
      _onMousemove: function(e) {
        if (!this.isDrawing) {
          return;
        }
        mouseX = e.pageX - this.offsetLeft;
        mouseY = e.pageY - this.offsetTop;

        this.fillCircle(mouseX, mouseY, this.lastX, this.lastY, 6);
        this.emitFillEvent(this.ctx.fillStyle, mouseX, mouseY, this.lastX, this.lastY, 6 )

        this.lastX = mouseX;
        this.lastY = mouseY;

      },

      _onMousedown: function(e) {
        this.isDrawing = true;
        this.lastX = e.pageX - this.offsetLeft;
        this.lastY = e.pageY - this.offsetTop;

        this.ctx.fillStyle = rainbow(50,this.color++);
        if (this.color>50) { this.color = 0; }
      },

      _onMouseup :function(e) {
        this.isDrawing = false;
        this.saveDrawingLocally();
        this.emitSaveDrawingsEvent(this.drawings);
      },

      _onMousewheel: function(e) {
        var delta = e.detail ? e.detail * (-120) : e.wheelDelta;
        this.ctx.fillStyle = "rgb(" + delta + ",0,0)";
      },

      _onQuestionType: function(evt){
        if(!evt || ! evt.questionType) return;

        if(evt.questionType == 'asq-text-input-q'){
          if(evt.type == "progress"){
            this._onProgress(evt);
          }
          else if(evt.type == "restorePresenter"){
            this._onRestorePresenter(evt);
          }
        }
      },

      _onAsqPluginCustomData: function(evt) {
        if (evt.data.command == 'storeDrawingsLocally' && evt.data.pluginCustomData) {
            this.drawings = evt.data.pluginCustomData.drawings || {};
        }
      },

      _onGoto: function(evt) {
        var id = evt.data.step || evt.data.id;
        // we are at the beginning or resume the presentation
        if (!this.lastStep) {
          this.lastStep = id;
          this.emitGetDrawingsEvent();
        }

        // erase the current drawing
        this.clearTo();
        this.emitClearToEvent();

        // draw the drawing of the new slide if there is one
        this.loadImage(id);
        this.emitLoadImageEvent(this.drawings[id]);

        this.lastStep = id;
      },

      // draw the current drawing and retrieve the extra slides if the viewer connects later
      _onConnected: function(evt) {
        this.drawings[this.lastStep] = this.$.canvas.toDataURL();
        this.emitLoadImageEvent(this.drawings[this.lastStep]);

        // add additional slides if Reveal is used
        if (document.querySelector('.reveal')) {
          this.emitGetSlidesEvent();
        }
      },

      emitClearToEvent: function(){
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: "clearTo"
          }
        });
      },

      emitMakeNonInteractiveEvent: function(){
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: "makeNonInteractive"
          }
        });
      },

      emitMakeInteractiveEvent: function(){
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: "makeInteractive"
          }
        });
      },

      emitFillEvent: function(fillStyle, mouseX, mouseY, lastX, lastY, lineThickness){
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: "fillCircle",
            fillStyle: fillStyle,
            mouseX: mouseX,
            mouseY: mouseY,
            lastX: lastX,
            lastY: lastY,
            lineThickness : lineThickness
          }
        });
      },

      emitLoadImageEvent: function(data) {
        data = data || this.emptyCanvasData;
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: "loadImage",
            dataURL: data
          }
        });
      },

      emitSaveDrawingsEvent: function(drawings) {
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: 'saveDrawings',
            drawings: drawings
          }
        });
      },

      emitGetDrawingsEvent: function() {
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: 'getDrawings',
          }
        });
      },

      emitGetSlidesEvent: function() {
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: 'getSlides',
          }
        });
      },

      created: function(){
        document.addEventListener('asq-ready', function(evt){
          try {
          this._subscribeToEvents(this.eventBus);
          }
          catch (err) {
            console.debug('failed to _subscribeToEvents');
          }
        }.bind(this));
      },

      ready: function() {
        // add drawing tool buttons event listeners
        this.$.toggleDrawing.addEventListener('click', this._toggleMenu.bind(this));

        // change the paper swatch picker icon
        var paletteIcon = this.$.colorBtn.shadowRoot.querySelector('#iconButton');
        paletteIcon.icon = "image:palette";
      },

      _subscribeToEvents: function(eventBus) {
        eventBus.on('asq:goto', this._onGoto.bind(this));
        eventBus.on('asq:folo-connected', this._onConnected.bind(this));
        eventBus.on('asq:ghost-connected', this._onConnected.bind(this));
        eventBus.on('asq-plugin', this._onAsqPluginCustomData.bind(this));
      },

      _toggleMenu: function(evt) {
        if (evt.target.icon == "image:brush") {
          evt.target.icon = "clear";
          this.isInteractive = true;
          this.emitMakeInteractiveEvent();
          this.activeCanvas = !this.activeCanvas;

          this.$.slideUtils.className = "activeSlideUtils";
          Polymer.dom(this.root).querySelectorAll('.drawingMenu').forEach(function(button) {
            button.className = "activeMenu"
          });
        }
        else {
          evt.target.icon = "image:brush";
          this.isInteractive = false;
          this.emitMakeNonInteractiveEvent();
          evt.target.style.pointerEvents = "auto";
          this.activeCanvas = !this.activeCanvas;

          this.$.slideUtils.className = "";
          Polymer.dom(this.root).querySelectorAll('.activeMenu').forEach(function(button) {
            button.className = "drawingMenu"
          });
        }
      },

      _indexOfSlide: function(slide) {
        var children = slide.parentNode.children;
        var num = 0;
        for (var i = 0; i < children.length; i++) {
          if (children[i] == slide) return num;
          if (children[i].nodeType == 1) num++;
        }
        return -1;
      },

      _idGenerator: function() {
        var S4 = function() {
          return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
        };
        return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
      },

      _addSlide: function(atEnd) {
        var addedSlideIndex, slideId;
        var atLast = false;

        // REVEAL
        if (document.querySelector('.reveal')) {
          if (!atEnd) { // insert after current slide
            var currentSlide = document.querySelector('section.present');
            addedSlideIndex = this._indexOfSlide(currentSlide) + 1;
          }
          else { // insert at the end
            addedSlideIndex = document.querySelector('.reveal .slides').children.length;
          }

          slideId = "s" + this._idGenerator();

          if (!this.eventBus) return;
          this.eventBus.emit('asq-plugin', {
            type: 'asq-canvas',
            data: {
              command: 'addSlide',
              content: '',
              index: addedSlideIndex,
              id: slideId
            }
          });
        }
      },

      _openAddSlideDialog: function() {
        this.$.addSlideDialog.open();
      },

      _addSlideAtEnd: function() {
        this._addSlide(true);
      },

      _addSlideAfterCurrentSlide: function() {
        this._addSlide(false);
      },

      _downloadCurrentCanvas: function() {
        let link = document.createElement('a');
        Polymer.dom(this.root).appendChild(link);
        link.href = this.$.canvas.toDataURL();
        link.download = 'canvas';
        link.click();
        Polymer.dom(this.root).removeChild(link);
      }

    });
  })();
</script>

<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../asq-base/asq-base.html">
<link rel="import" href="asq-canvas-behaviour.html">
<link rel="import" href="asq-canvas-style.html">
<link rel="import" href="asq-canvas-icons.html">


<!--
`asq-canvas-presenter` provides the presenter view of `asq-canvas`.

Example:

    <asq-canvas-presenter for="leId">
    </asq-canvas-presenter>


@element asq-canvas-presenter
@demo demo/stats.html
@group ASQ Elements
@blurb Element provides a canvas for `asq-canvas` elements.
@homepage http://github.com/ASQ-USI-Elements/asq-canvas
-->
<dom-module id="asq-canvas-presenter">

  <template>

    <style include="asq-canvas-style"></style>

    <canvas id="canvas" on-mousemove="_onMousemove" on-mousedown="_onMousedown" on-mouseup="_onMouseup"></canvas>

    <paper-dialog id="addSlideDialog">
      <h2>Add a new slide</h2>
      <div class="buttons">
        <paper-button on-click="_addSlideAfterCurrentSlide">after current slide</paper-button>
        <paper-button on-click="_addSlideAtEnd">at the end</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="changeLineWidthDialog">
      <h2>Change the line width</h2>
      <div id="widthSlider">
        <paper-slider id="lineWidthSlider" value="[[lineWidth]]" min="1" max="50" editable></paper-slider>
      </div>
    </paper-dialog>

    <div id="drawingTools">
      <div id="slideUtils">
        <paper-icon-button id="addSlide" class="drawingMenu" title="add a new slide" icon="add" on-click="_openAddSlideDialog"></paper-icon-button>
        <paper-icon-button id="removeSlide" class="drawingMenu" title="remove an inserted slide" icon="remove" on-click="_removeSlide"></paper-icon-button>
        <paper-icon-button class="drawingMenu" title="download the current drawing" icon="file-download" on-click="_downloadCurrentCanvas"></paper-icon-button>
    </div>

    <paper-icon-button id="toggleDrawing" title="open drawing tools" icon="image:brush"></paper-icon-button>
    <paper-icon-button id="penBtn" class="drawingMenu active-tool" title="start drawing" icon="create"></paper-icon-button>
    <paper-swatch-picker id="colorBtn" class="drawingMenu" title="change color" color="{{selectedColor}}"></paper-swatch-picker>
    <paper-icon-button id="sizeBtn" class="drawingMenu" title="change pencil size" icon="image:lens" on-click="_openChangeLineWidthDialog"></paper-icon-button>
    <paper-icon-button id="eraseBtn" class="drawingMenu" title="use the eraser" icon="asq-canvas-icons:eraser"></paper-icon-button>
  </div>

  </template>
</dom-module>
<script>
  (function() {

    Polymer({

      is: 'asq-canvas-presenter',
      behaviors: [ASQ.asqCanvasElementBehavior],

      properties: {
        /**
         * whether the canvas will accept pointer events or not.
         */
        isInteractive: {
          type: Boolean,
          value: false,
          observer: "_isInteractiveChanged",
          notify: true
        },

        /**
         * Object that saves the drawing for its corresponding slide.
         */
        drawings: {
          type: Object,
          value: {},
        },

        /**
         * Indicates if the canvas got the drawings from the DB.
         */
        gotDrawings: {
          type: Boolean,
          value: false,
        },

        /**
         * Indicates if the slides have been loaded
         */
        slidesLoaded: {
          type: Boolean,
          value: false,
        },

      },

      created: function(){
        document.addEventListener('asq-ready', function(evt){
          try {
          this._subscribeToEvents(this.eventBus);
          }
          catch (err) {
            console.debug('failed to _subscribeToEvents');
          }
        }.bind(this));
      },

      ready: function() {
        // add drawing tool buttons event listeners
        this.$.toggleDrawing.addEventListener('click', this._toggleMenu.bind(this));
        this.$.penBtn.addEventListener('click', this._draw.bind(this));
        this.$.eraseBtn.addEventListener('click', this._erase.bind(this));

        // change the paper swatch picker icon
        var paletteIcon = this.$.colorBtn.shadowRoot.querySelector('#iconButton');
        paletteIcon.icon = "image:palette";
      },

      attached: async function() {
        if (window.location.search.match(/print-pdf/gi)) this.printing = true;

        this._setDrawingProperties({ activeCanvas : false, activeTool : "pen" });
        this._emitGetSlidesEvent();

        if (this.printing) {
          await this._sleep(1000);
          this.$.canvas.width = document.body.offsetWidth;
          this.$.canvas.height = document.querySelector('.reveal').offsetHeight;

          this._emitGetDrawingsEvent();
          if (!this.gotDrawings) await this._sleep(1000);

          Object.getOwnPropertyNames(this.drawings).forEach(async function(slideId) {
            this._setSlideProperties(slideId);
            this._loadImage(this.drawings[slideId]);
          }.bind(this));
        }
      },

      _subscribeToEvents: function(eventBus) {
        eventBus.on('asq:goto', this._onGoto.bind(this))
        eventBus.on('asq:folo-connected', this._onConnected.bind(this));
        eventBus.on('asq:ghost-connected', this._onConnected.bind(this));
        eventBus.on('asq-plugin', this._onAsqPluginCustomData.bind(this));
      },

      _isInteractiveChanged: function(newVal, oldVal){
        this.style.pointerEvents = newVal ? "auto" : "none";
      },

      _onAsqPluginCustomData: function(evt) {
        if (evt.data.command == 'storeDrawingsLocally') {
          this.gotDrawings = true;
          if (evt.data.pluginCustomData) this.drawings = evt.data.pluginCustomData.drawings || {};
        }
      },

      // draw the current drawing and retrieve the extra slides if the viewer connects later
      _onConnected: function(evt) {
        this._emitLoadImageEvent(this.drawings[this.lastStep]);
        this._emitGetSlidesEvent();
      },

      _onGoto: async function(evt) {
        if (!this.printing) {
          var id = evt.data.step || evt.data.id;
          // we are at the beginning or resume the presentation
          if (!this.lastStep) {
            if (id == '0' && document.querySelector('.reveal')) {
              id = document.querySelector('.slides section:first-child').id;
            }
            this.lastStep = id;
            this._emitGetDrawingsEvent();
          }

          if (!this.gotDrawings) await this._sleep(1000);

          this.drawings[this.lastStep] = this.drawings[this.lastStep] || [];

          this.lastStep = id;

          await this._setSlideProperties();

          this._changeDrawingOnGoto(id);
        }
      },

      _onMousedown: function(evt) {
        this._setDrawingProperties({ updateLastXY : true, pageX : evt.pageX, pageY : evt.pageY, isDrawing : true });
        if (this.activeTool == "pen") {
          this.drawingColor = this.$.colorBtn.color;
          this.lineWidth = this.$.lineWidthSlider.value;
        }

        this.drawings[this.lastStep] = this.drawings[this.lastStep] || [];

        this._drawCircle(this.mouseX, this.mouseY, this.lineWidth);
        this._emitFillEvent('circle')
        this._pushLastDrawing('circle');
      },

      // bind mouse events
      _onMousemove: function(e) {
        if (!this.isDrawing) return;
        this._setDrawingProperties({ pageX : e.pageX, pageY : e.pageY });

        this._drawLine(this.mouseX, this.mouseY, this.lastX, this.lastY, this.lineWidth);
        this._emitFillEvent("line")

        this._pushLastDrawing('line');

        this._setDrawingProperties({ updateLastXY : true });
      },

      _onMouseup :function(e) {
        this.isDrawing = false;
        this._emitSaveDrawingsEvent(this.drawings);
      },

      _emitClearToEvent: function(){
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: "clearTo"
          }
        });
      },

      _emitFillEvent: function(form){
        if (!this.eventBus) return;

        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: "drawOnCanvas",
            form: form,
            mouseX: this.mouseX,
            mouseY: this.mouseY,
            lastX: this.lastX,
            lastY: this.lastY,
            drawingColor: this.drawingColor,
            lineWidth: this.lineWidth,
            slideWidth: this.slideWidth,
            slideHeight: this.slideHeight,
            sMX: this.sMX,
            sMY: this.sMY
          }
        });
      },

      _emitGetDrawingsEvent: function() {
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: 'getDrawings',
          }
        });
      },

      _emitGetSlidesEvent: function() {
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: 'getSlides',
          }
        });
      },

      _emitLoadImageEvent: function(data) {
        data = data || this.emptyCanvasData;
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: "loadImage",
            data: data,
          }
        });
      },

      _emitSaveDrawingsEvent: function(drawings) {
        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: 'saveDrawings',
            drawings: drawings
          }
        });
      },

      _addSlide: function(atEnd) {
        var addedSlideIndex, slideId, prevX;

        if (!atEnd) { // insert after current slide
          var currentSlide = document.querySelector('section.present');
          addedSlideIndex = this._indexOfSlide(currentSlide) + 1;
        }
        else { // insert at the end
          if (document.querySelector('.reveal')) {
            addedSlideIndex = document.querySelector('.reveal .slides').children.length;
          }
          else addedSlideIndex = document.querySelector('#impress > div').children.length;
        }

        slideId = "s" + this._idGenerator();
        prevX = currentSlide.dataset.x;

        if (!this.eventBus) return;
        this.eventBus.emit('asq-plugin', {
          type: 'asq-canvas',
          data: {
            command: 'addSlide',
            content: '',
            index: addedSlideIndex,
            id: slideId,
            prevX: prevX
          }
        });

      },

      _addSlideAfterCurrentSlide: function() {
        this._addSlide(false);
      },

      _addSlideAtEnd: function() {
        this._addSlide(true);
      },

      _changeDrawingOnGoto: function(id) {
        this._clearTo();
        this._emitClearToEvent();

        if (document.querySelector('.reveal')) {
          if (this.drawings[id]) {
            this._loadImage(this.drawings[id]);
            this._emitLoadImageEvent(this.drawings[id]);
          }
        }
        else {
          setTimeout(function() {
            if (this.drawings[id]) {
              this._loadImage(this.drawings[id]);
              this._emitLoadImageEvent(this.drawings[id]);
            }
          }.bind(this), 1000);
        }
      },

      _downloadCurrentCanvas: function() {
        var link = document.createElement('a');
        Polymer.dom(this.root).appendChild(link);
        link.href = this.$.canvas.toDataURL();
        link.download = 'canvas';
        link.click();
        Polymer.dom(this.root).removeChild(link);
      },

      _draw: function(evt) {
        this.activeTool = "pen";
        evt.target.classList.add('active-tool');
        if (this.$.eraseBtn.classList.contains('active-tool')) this.$.eraseBtn.classList.remove('active-tool');
        this._setDrawingProperties({ drawingColor : this.$.colorBtn.color, gCO : 'source-over'});
      },

      _erase: function(evt) {
        this.activeTool = "eraser";
        evt.target.classList.add('active-tool');
        if (this.$.penBtn.classList.contains('active-tool')) this.$.penBtn.classList.remove('active-tool');
        this._setDrawingProperties({ drawingColor : 'rgba(0,0,0,1)', gCO : 'destination-out'});
      },

      _indexOfSlide: function(slide) {
        var children = slide.parentNode.children;
        var num = 0;
        for (var i = 0; i < children.length; i++) {
          if (children[i] == slide) return num;
          if (children[i].nodeType == 1) num++;
        }
        return -1;
      },

      _idGenerator: function() {
        var S4 = function() {
          return (((1 + Math.random()) * 0x10000)| 0).toString(16).substring(1);
        };
        return (S4() + S4() + "-" + S4()+ "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
      },

      _openAddSlideDialog: function() {
        this.$.addSlideDialog.open();
      },

      _openChangeLineWidthDialog: function() {
        this.$.changeLineWidthDialog.open();
      },

      _pushLastDrawing: function(form) {
        this.drawings[this.lastStep].push({
          form: form,
          mouseX: this.mouseX,
          mouseY: this.mouseY,
          lastX: this.lastX,
          lastY: this.lastY,
          drawingColor: this.drawingColor,
          lineWidth: this.lineWidth,
          slideWidth: this.slideWidth,
          slideHeight: this.slideHeight,
          sMX: this.sMX,
          sMY: this.sMY,
          gCO: this.ctx.globalCompositeOperation
        });
      },

      _removeSlide: function() {
        if (this.currentSlide.innerHTML == '') {
          if (!this.eventBus) return;
          this.eventBus.emit('asq-plugin', {
            type: 'asq-canvas',
            data: {
              command: 'removeSlide',
              id: currentSlide.id,
            }
          });
        }
      },

      _toggleMenu: function(evt) {
        if (evt.target.icon == "image:brush") {
          evt.target.icon = "clear";
          this.isInteractive = true;
          this.activeCanvas = !this.activeCanvas;
          this.$.slideUtils.classList.add('activeSlideUtils');
          Polymer.dom(this.root).querySelectorAll('.drawingMenu').forEach(function(button) {
            button.classList.remove('drawingMenu');
            button.classList.add('activeMenu');
          });
          this.$.penBtn.click();
        }
        else {
          evt.target.icon = "image:brush";
          this.isInteractive = false;
          evt.target.style.pointerEvents = "auto";
          this.activeCanvas = !this.activeCanvas;
          this.$.slideUtils.className = "";
          Polymer.dom(this.root).querySelectorAll('.activeMenu').forEach(function(button) {
            button.classList.remove('activeMenu');
            button.classList.add('drawingMenu');
          });
        }
      },

    });
  })();
</script>

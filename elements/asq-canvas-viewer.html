<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../asq-base/asq-base.html">
<link rel="import" href="asq-canvas-behaviour.html">
<link rel="import" href="asq-canvas-style.html">

<!--
`asq-canvas-viewer` provides the presenter view of `asq-text-input-q-stats`.

Example:

    <asq-canvas-viewer for="leId">
    </asq-canvas-viewer>


@element asq-canvas-viewer
@demo demo/stats.html
@group ASQ Elements
@blurb Element provides a stats for `asq-text-input-q` elements.
@homepage http://github.com/ASQ-USI-Elements/asq-text-input-q
-->
<dom-module id="asq-canvas-viewer">

  <template>

    <style include="asq-canvas-style"></style>

    <canvas id="canvas"></canvas>

  </template>
</dom-module>

<script>
  (function() {

    Polymer({
      is: 'asq-canvas-viewer',
      behaviors: [ASQ.asqCanvasElementBehavior],

      properties: {
        lastDrawing: {
          type: Array,
          value: [],
        },

        eventBus: {
          type: Object,
          observer: "_eventBusChanged",
          notify: true
        },
      },

      _eventBusChanged: function (eventBus, old) {
        if(!eventBus) return;
        eventBus.on('asq-plugin', this._onAsqPlugin.bind(this));
      },

      _onAsqPlugin: function(evt){
        if(evt.type !== "asq-canvas") return;

        var d = evt.data;

        switch (d.command){
          case "drawOnCanvas":

            var currentSlide = document.querySelector('.present').getBoundingClientRect();

            // get the width and height of the viewer's current slide
            var vSlideWidth = currentSlide.width;
            var vSlideHeight = document.body.offsetHeight - currentSlide.top - (document.body.offsetHeight - currentSlide.bottom);

            // get the midpoint of the viewer's current slide
            var vSMX = currentSlide.left + vSlideWidth/2;
            var vSMY = currentSlide.top + vSlideHeight/2;

            var x1 = this._computeCoordinate(d.mouseX, d.pSlideWidth, vSlideWidth, d.pSMX, vSMX);
            var y1 = this._computeCoordinate(d.mouseY, d.pSlideHeight, vSlideHeight, d.pSMY, vSMY);
            var x2 = this._computeCoordinate(d.lastX, d.pSlideWidth, vSlideWidth, d.pSMX, vSMX);
            var y2 = this._computeCoordinate(d.lastY, d.pSlideHeight, vSlideHeight, d.pSMY, vSMY);

            // calculate the lineWidth for the viewer
            var lineWidth = d.lineWidth * (vSlideWidth * vSlideHeight)/(d.pSlideWidth * d.pSlideHeight)

            // set the drawing properties
            this.drawingColor = d.drawingColor;
            this.lineWidth = lineWidth;
            this.ctx.fillStyle = this.drawingColor;
            this.ctx.strokeStyle = this.drawingColor;
            this.ctx.globalCompositeOperation = d.gCO;
            this.lastDrawing.push(d);

            if (d.form == "circle") {
              this._drawCircle(x1, y1, this.lineWidth);
            }
            else if (d.form == "line") {
              this._drawLine(x1, y1, x2, y2, this.lineWidth);
            }
            break;
          case "clearTo":
            this._clearTo();;
            break;

          case "loadImage":
            if (d.data) {
              this.lastDrawing = d.data;
              this.currentSlide = d.slideId;
              this._loadImage(this.lastDrawing, d.slideId);
            }
            break;
        }
      },

    });
  })();
</script>

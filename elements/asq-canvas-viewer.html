<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../asq-base/asq-base.html">

<!--
`asq-canvas-viewer` provides the presenter view of `asq-text-input-q-stats`.

Example:

    <asq-canvas-viewer for="leId">
    </asq-canvas-viewer>


@element asq-canvas-viewer
@demo demo/stats.html
@group ASQ Elements
@blurb Element provides a stats for `asq-text-input-q` elements.
@homepage http://github.com/ASQ-USI-Elements/asq-text-input-q
-->
<dom-module id="asq-canvas-viewer">

  <template>

    <style>
      :host {
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }

      #canvas{
        width: 100%;
        @apply(--layout-flex);
        cursor: crosshair;
      }

      #canvas:active {
        cursor: crosshair;
      }

    </style>


  <canvas id="canvas"></canvas>

  </template>
</dom-module>
<script>
  (function() {

    Polymer({

      is: 'asq-canvas-viewer',
      behaviors: [ASQ.asqCanvasElementBehavior],

      properties: {

        /**
         * Event bus to communicate with ASQ.
         */
        eventBus: {
          type: Object,
          observer: "_eventBusChanged",
          notify: true
        },

        lastDrawing: {
          type: Object,
          value: {},
        }
      },

      attached: function(){

        this.ctx = this.$.canvas.getContext('2d');
        this.lastX = 0;
        this.lastY = 0;
        this.color = 0;
        this.activeCanvas = false;

        window.addEventListener('resize', this.resizeCanvas.bind(this), false);
        this.resizeCanvas();
      },

      resizeCanvas: function () {
        this.$.canvas.width = this.offsetWidth;
        this.$.canvas.height = this.offsetHeight;

        this.loadImage(this.lastDrawing.drawing);
      },

      _drawLine: function(x1, y1, x2, y2, lineThickness) {
        this._drawOnCanvas("line", x1, y1, lineThickness, x2, y2);
      },

      _drawCircle: function(x, y, lineThickness) {
        this._drawOnCanvas("circle", x, y, lineThickness);
      },

      _drawOnCanvas: function(form, x1, y1, lineThickness, x2, y2) {
        var radius = lineThickness/2;

        for (var i = 0; i < lineThickness * lineThickness; ++i) {
          var currentX = i%lineThickness;
          var currentY = Math.floor(i/lineThickness);

          var canvasX1 = x1 - radius + currentX;
          var canvasY1 = y1 - radius + currentY;

          var canvasX2 = x2 - radius + currentX;
          var canvasY2 = y2 - radius + currentY;

          if (Math.pow(Math.abs(canvasX1 - x1), 2) + Math.pow(Math.abs(canvasY1 - y1), 2) < radius * radius) {
            switch (form) {
              case "circle":
                this.ctx.fillRect(canvasX1, canvasY1, 1, 1);
                break;

              case "line":
                this.ctx.beginPath();
                this.ctx.moveTo(canvasX1, canvasY1);
                this.ctx.lineTo(canvasX2, canvasY2);
                this.ctx.stroke();
                break;
            }
          }
        }
      },

      clearTo : function() {
        this.ctx.clearRect(0, 0, this.$.canvas.width, this.$.canvas.height);
      },

      loadImage: function(data) {
        var img = new Image();
        if (data) {
          var context = this.ctx;
          img.addEventListener("load", function(evt) {
            setTimeout(function() {
              context.drawImage(img, 0, 0);
            }, 1000);
          });
          img.src = data;
        }
      },

      _onAsqPlugin: function(evt){
        if(evt.type !== "asq-canvas") return;

        var d = evt.data;

        switch (d.command){
          case "fillCircle":
            // calculate the viewer's x and y
            var vWidth = parseInt(getComputedStyle(document.body, null).width);
            var vHeight = parseInt(getComputedStyle(document.body, null).height);

            var x1 = this._computeCoordinate(d.mouseX, d.pWidth, vWidth);
            var y1 = this._computeCoordinate(d.mouseY, d.pHeight, vHeight);

            var x2 = this._computeCoordinate(d.lastX, d.pWidth, vWidth);
            var y2 = this._computeCoordinate(d.lastY, d.pHeight, vHeight);

            // calculate the lineThickness for the viewer
            var lineThickness = d.lineThickness * (vWidth * vHeight)/(d.pWidth * d.pHeight)

            // set the drawing properties
            this.drawingColor = d.drawingColor;
            this.lineThickness = lineThickness;
            this.ctx.fillStyle = this.drawingColor;
            this.ctx.strokeStyle = this.drawingColor;
            if (d.form == "circle") {
              this._drawCircle(x1, y1, this.lineThickness);
            }
            else if (d.form == "line") {
              this._drawLine(x1, y1, x2, y2, this.lineThickness);
            }
            break;
          case "clearTo":
            this.clearTo();;
            break;

          case "loadImage":
            this.lastDrawing.drawing = d.dataURL;
            this.loadImage(this.lastDrawing.drawing);
            break;
        }
      },

      _computeCoordinate: function(pCoordinate, pSize, vSize) {
        return pCoordinate * vSize/pSize;
      },

      _eventBusChanged: function (eventBus, old) {
        if(!eventBus) return;
        eventBus.on('asq-plugin', this._onAsqPlugin.bind(this));
      },


    });
  })();
</script>
